@page "/login"
@using global::Billetera.Shared.DTOS
@using global::Billetera.Servicio.ServiciosHttp
@inject IAuthService authService
@inject NavigationManager Navigation

<h3>Iniciar Sesi칩n</h3>

@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger">@mensajeError</div>
}

<EditForm Model="usuario" OnValidSubmit="Grabar">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label>CUIL</label>
        <input type="text"
               class="form-control"
               value="@usuario.CUIL"
               @oninput="OnCuilInput"
               placeholder="XX-XXXXXXXX-X"
               maxlength="13" />
        <ValidationMessage For="@(() => usuario.CUIL)" />
    </div>

    <div class="form-group">
        <label>Correo</label>
        <InputText class="form-control" @bind-Value="usuario.Correo" />
    </div>

    <div class="form-group">
        <label>Contrase침a</label>
        <div class="input-group">
            <InputText type="@tipoInputPassword" class="form-control" @bind-Value="usuario.Password" />
            <button class="btn btn-outline-secondary" type="button" @onclick="TogglePasswordVisibility">游녜</button>
        </div>
    </div>

    <br />
    <button type="submit" class="btn btn-primary">Iniciar Sesi칩n</button>
    <button class="btn btn-secondary" type="button" @onclick="Cancelar">Volver Atr치s</button>
</EditForm>

@code {
    private UsuariosDTO.Login usuario = new();
    private string? mensajeError;
    private bool mostrarPassword = false;
    private string tipoInputPassword => mostrarPassword ? "text" : "password";

    private void TogglePasswordVisibility() => mostrarPassword = !mostrarPassword;
    private void OnCuilInput(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrEmpty(valor))
        {
            usuario.CUIL = string.Empty;
            return;
        }

        // Eliminar todo excepto n칰meros
        var soloNumeros = new string(valor.Where(char.IsDigit).ToArray());

        //  11 d칤gitos
        if (soloNumeros.Length > 11)
            soloNumeros = soloNumeros.Substring(0, 11);

        // Formato
        if (soloNumeros.Length <= 2)
        {
            usuario.CUIL = soloNumeros;
        }
        else if (soloNumeros.Length <= 10)
        {
            usuario.CUIL = $"{soloNumeros.Substring(0, 2)}-{soloNumeros.Substring(2)}";
        }
        else 
        {
            usuario.CUIL = $"{soloNumeros.Substring(0, 2)}-{soloNumeros.Substring(2, 8)}-{soloNumeros.Substring(10)}";
        }
    }

    private async Task Grabar()
    {
        try
        {
            mensajeError = null;
            await authService.Login(usuario);
            Navigation.NavigateTo("/billetera", forceLoad: true);
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
    }

    private void Cancelar() => Navigation.NavigateTo("/");
}