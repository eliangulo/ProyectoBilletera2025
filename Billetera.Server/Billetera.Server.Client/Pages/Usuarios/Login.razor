@page "/login"
@using global::Billetera.Shared.DTOS
@using global::Billetera.Servicio.ServiciosHttp
@inject IAuthService authService
@inject NavigationManager Navigation

<h3>Iniciar Sesi√≥n</h3>

@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger">@mensajeError</div>
}

<EditForm Model="usuario" OnValidSubmit="Grabar">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label>CUIL</label>
        <input type="text"
        class="form-control"
        @bind="CuilFormateado"
        @bind:event="oninput"
        placeholder="Ingrese CUIL"
        maxlength="13"
        inputmode="numeric" />
        <ValidationMessage For="@(() => usuario.CUIL)" />
    </div>

    <div class="form-group">
        <label>Correo</label>
        <InputText class="form-control" @bind-Value="usuario.Correo" placeholder="Ingrese su correo electronico" />
    </div>

    <div class="form-group">
        <label>Contrase√±a</label>
        <div class="input-group">
            <InputText type="@tipoInputPassword" class="form-control" @bind-Value="usuario.Password" placeholder="Ingrese su contrase√±a" />
            <button class="btn btn-outline-secondary" type="button" @onclick="TogglePasswordVisibility">üëÅ</button>
        </div>
    </div>

    <br />
    <button type="submit" class="btn btn-primary">Iniciar Sesi√≥n</button>
    <button class="btn btn-secondary" type="button" @onclick="Cancelar">Volver Atr√°s</button>
</EditForm>

@code {
    private UsuariosDTO.Login usuario = new();
    private string? mensajeError;
    private bool mostrarPassword = false;
    private string tipoInputPassword => mostrarPassword ? "text" : "password";

    private void TogglePasswordVisibility() => mostrarPassword = !mostrarPassword;
    private string CuilFormateado
    {
        get => usuario.CUIL ?? string.Empty;

        set
        {
            if (string.IsNullOrEmpty(value))
            {
                usuario.CUIL = string.Empty;
                return;
            }


            // Eliminar todo excepto n√∫meros
            var soloNumeros = new string(value.Where(char.IsDigit).ToArray());
            //  11 d√≠gitos
            if (soloNumeros.Length > 11)
                soloNumeros = soloNumeros.Substring(0, 11);

            // Formato
            if (soloNumeros.Length <= 2)
            {
                usuario.CUIL = soloNumeros;
            }
            else if (soloNumeros.Length <= 10)
            {
                usuario.CUIL = $"{soloNumeros.Substring(0, 2)}-{soloNumeros.Substring(2)}";
            }
            else
            {
                usuario.CUIL = $"{soloNumeros.Substring(0, 2)}-{soloNumeros.Substring(2, 8)}-{soloNumeros.Substring(10)}";
            }
        }
    }

    private async Task Grabar()
    {
        try
        {
            mensajeError = null;
            await authService.Login(usuario);
            Navigation.NavigateTo("/billetera", forceLoad: true);
        }
        catch (HttpRequestException ex)
        {
            // Extraer el mensaje de error HTTP del servidor
            var mensaje = ex.Message;

            // Buscar si hay un mensaje en el error
            if (mensaje.Contains("\"mensaje\"") || mensaje.Contains("mensaje"))
            {
                // Intentar extraer solo el mensaje limpio
                var inicioMensaje = mensaje.IndexOf("mensaje");
                if (inicioMensaje >= 0)
                {
                    // Buscar el valor despu√©s de "mensaje":"
                    var inicioCita = mensaje.IndexOf("\"", inicioMensaje + 10);
                    var finCita = mensaje.IndexOf("\"", inicioCita + 1);

                    if (finCita > inicioCita)
                    {
                        mensajeError = mensaje.Substring(inicioCita + 1, finCita - inicioCita - 1);
                        return;
                    }
                }
            }

            // Si no se pudo extraer, mostrar el mensaje completo
            mensajeError = mensaje.Contains("401") || mensaje.Contains("Unauthorized")
                ? "CUIL o contrase√±a incorrectos"
                : "Error al iniciar sesi√≥n";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
    }
    private void Cancelar() => Navigation.NavigateTo("/");
}