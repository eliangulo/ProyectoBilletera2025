@inject IHttpServicio http

<link href="css/alias.css" rel="stylesheet" />

<div class="alias-container">
    @if (!estaEditando)
    {
        <!-- Solo se ve el alias y el botón de lápiz -->
        <div class="alias-display">
            <span class="alias-icono">Alias:</span>

            <!-- El alias actual -->
            <span class="alias-texto">@AliasActual</span>
            
            <!-- Botón para entrar al modo edición -->
            <button class="btn-editar" @onclick="IniciarEdicion" title="Editar alias">
                <!-- SVG del lápiz -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                </svg>
            </button>
        </div>
    }
    else
    {
        <!--Campo de texto + botones guardar/cancelar-->
        <div class="alias-edit">
            <!-- Campo de texto donde escribes el nuevo alias -->
            <input type="text" 
                   class="alias-input" 
                   @bind="nuevoAlias" 
                   @bind:event="oninput"
                   placeholder="Ingrese nuevo alias"
                   maxlength="100" />
            
            <!-- Botón GUARDAR -->
            <button class="btn-guardar" @onclick="GuardarAlias" disabled="@guardando">
                @if (guardando)
                {
                    <span>...</span>
                }
                else
                {
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                }
            </button>
            
            <!-- Botón CANCELAR -->
            <button class="btn-cancelar" @onclick="CancelarEdicion" disabled="@guardando">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                </svg>
            </button>
        </div>
    }

    <!-- MENSAJES DE ERROR Y ÉXITO-->
    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert-error">@mensajeError</div>
    }

    @if (!string.IsNullOrEmpty(mensajeExito))
    {
        <div class="alert-success">@mensajeExito</div>
    }
</div>

@code {
  
    [Parameter]
    public int TipoCuentaId { get; set; }

    [Parameter]
    public string AliasActual { get; set; } = "";

    [Parameter]
    public EventCallback OnAliasActualizado { get; set; }
    
    private bool estaEditando = false;  
    private string nuevoAlias = "";      
    private bool guardando = false;      
    private string mensajeError = "";    
    private string mensajeExito = "";    

    /* Iniciar edición. Se ejecuta al hacer clic en el lápiz*/
    private void IniciarEdicion()
    {
        estaEditando = true;              
        nuevoAlias = AliasActual;         
        mensajeError = "";                
        mensajeExito = "";                
    }

    /* Cancelar edición. Se ejecuta al hacer clic en la X roja */
    private void CancelarEdicion()
    {
        estaEditando = false;             
        nuevoAlias = "";                  
        mensajeError = "";               
        mensajeExito = "";               
    }

    /* Guardar alias. Se ejecuta al hacer clic en el check verde*/
    private async Task GuardarAlias()
    {
        try
        {
            Console.WriteLine($"🔵 [ALIAS] Iniciando guardado del alias");
            Console.WriteLine($"🔵 [ALIAS] Alias actual: '{AliasActual}'");
            Console.WriteLine($"🔵 [ALIAS] Nuevo alias: '{nuevoAlias}'");
            Console.WriteLine($"🔵 [ALIAS] TipoCuentaId: {TipoCuentaId}");

            // VALIDACIÓN 1: No puede estar vacío

            if (string.IsNullOrWhiteSpace(nuevoAlias))
            {
                mensajeError = "El alias no puede estar vacio";
                Console.WriteLine($"❌ [ALIAS] ERROR: Alias vacio");
                return;
            }

            // VALIDACIÓN 2: Si no cambió, solo cancelar

            if (nuevoAlias.Trim() == AliasActual)
            {
                Console.WriteLine($"ℹ️ [ALIAS] Alias no cambio, cancelando");
                CancelarEdicion();
                return;
            }

            guardando = true;
            mensajeError = "";
            mensajeExito = "";

            Console.WriteLine($"[ALIAS] Llamando a: api/TipoCuenta/{TipoCuentaId}/actualizaralias");

            var respuesta = await http.Put<string, object>(
                $"api/TipoCuenta/{TipoCuentaId}/actualizaralias", 
                nuevoAlias
            );

            Console.WriteLine($"[ALIAS] Respuesta recibida. Error: {respuesta.Error}");


            if (!respuesta.Error)
            {
                
                Console.WriteLine($"✅[ALIAS] Alias actualizado exitosamente");
                
                AliasActual = nuevoAlias.Trim();
                mensajeExito = "✅ Alias actualizado";
                estaEditando = false;
                
                await Task.Delay(2000);
                mensajeExito = "";

                await OnAliasActualizado.InvokeAsync();
            }
            else
            {
                
                mensajeError = await http.ObtenerMensajeError(respuesta.HttpResponseMessage);
                Console.WriteLine($"❌ [ALIAS] ERROR del backend: {mensajeError}");
            }
        }
        catch (Exception ex)
        {
           
            mensajeError = $"Error: {ex.Message}";
            Console.WriteLine($"❌ [ALIAS] EXCEPCIÓN: {ex.Message}");
            Console.WriteLine($"❌ [ALIAS] StackTrace: {ex.StackTrace}");
        }
        finally
        {
            guardando = false;
            Console.WriteLine($"🔵 [ALIAS] Proceso finalizado. Guardando: {guardando}");
        }
    }
}